<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shop PWA VNPAY</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="assets/styles.css" />
  </head>
  <body>
    <!-- ================= HEADER ================= -->
    <header class="app-header">
      <div class="header-left">
        <h1>üõí VNPAY</h1>
      </div>
      <div class="header-right">
        <div class="cart-summary">
          üß∫ T·ªïng SP:
          <span id="cart-count">0</span>
          <br />
          T·ªïng ti·ªÅn:
          <span id="cart-total">0</span>
          VND
        </div>
        <div class="header-buttons">
          <button id="view-cart-btn">Xem chi ti·∫øt</button>
          <button id="clear-cart-btn">üóë X√≥a gi·ªè</button>
        </div>
      </div>
    </header>

    <!-- PRODUCT GRID -->
    <main>
      <section id="product-list" class="product-grid"></section>

      <!-- ================= CART DETAILS ================= -->
      <div id="cart-details" style="display: none">
        <h3>Chi ti·∫øt gi·ªè h√†ng</h3>
        <ul id="cart-list"></ul>
        <!-- ================= PAYMENT SECTION ================= -->
        <div id="payment-section" style="display: flex; flex-direction: column">
          <h4>Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</h4>

          <label>
            <input type="radio" name="payment-method" value="direct" checked />
            Tr·ª±c ti·∫øp
          </label>

          <label>
            <input type="radio" name="payment-method" value="vnpay-payment" />
            VNPAY Payment
          </label>

          <label>
            <input type="radio" name="payment-method" value="vnpay-deeplink" />
            VNPAY Deeplink
          </label>

          <label>
            <input type="radio" name="payment-method" value="vnpay-token" />
            VNPAY Token
          </label>

          <label>
            <input type="radio" name="payment-method" value="vnpay-ib" />
            VNPAY IB
          </label>
          <label>
            <input type="radio" name="payment-method" value="vnpay-isp" />
            VNPAY Tr·∫£ g√≥p
          </label>

          <label>
            <input type="radio" name="payment-method" value="vnpay-recurring" />
            VNPAY ƒê·ªãnh k·ª≥
          </label>

          <!-- Th√™m d√≤ng n√†y v√†o PAYMENT SECTION, c√πng nh√≥m radio -->
          <label>
            <input type="radio" name="payment-method" value="seapay" />
            SEAPAY QR
          </label>
        </div>

        <!-- ================= CHECKOUT INFO ================= -->
        <div id="checkout-info" style="display: none">
          <h4>Th√¥ng tin kh√°ch h√†ng</h4>
          <label>H·ªç v√† t√™n:</label>
          <input type="text" id="customer-name" required />
          <br />

          <label>S·ªë ƒëi·ªán tho·∫°i:</label>
          <input type="tel" id="customer-phone" required />
          <br />

          <label>Email:</label>
          <input type="email" id="customer-email" required />
          <br />

          <label>ƒê·ªãa ch·ªâ nh·∫≠n h√†ng:</label>
          <textarea id="customer-address" required></textarea>
          <br />
          <!-- N√∫t Thanh to√°n ch·ªâ cho VNPAY Payment -->
          <button id="payment-button" onclick="handlePayment()" style="display: none">Thanh to√°n</button>
          <button id="payment-button-ib" onclick="handlePaymentIB()" style="display: none">Thanh to√°n IB</button>
          <button id="payment-button-isp" onclick="handlePaymentISP()" style="display: none">Thanh to√°n tr·∫£ g√≥p</button>
          <button id="payment-button-recurring" onclick="handlePaymentRecurring()" style="display: none">
            Thanh to√°n ƒë·ªãnh k·ª≥
          </button>
          <button id="payment-button-seapay" onclick="handlePaymentSeapay()" style="display: none">
            Thanh to√°n SEAPAY
          </button>

          <br />
        </div>
        <!-- Form hidden ƒë·ªÉ POST VNPAY IB Doanh nghi·ªáp -->
        <form
          id="payment_form_ib"
          method="POST"
          action="https://sandbox.vnpayment.vn/biz-pay-svc/payment/pay"
          style="display: none">
          <input name="bpId" id="ispTxnId" type="text" />
          <input name="dataKey" id="dataKey" type="text" />
          <input name="tmnCode" id="tmnCode" type="text" />
        </form>
        <!-- Form hidden ƒë·ªÉ POST VNPAY Tr·∫£ g√≥p -->
        <form
          id="payment_form_isp"
          method="POST"
          action="https://sandbox.vnpayment.vn/isp-svc/payment/pay"
          style="display: none">
          <input name="ispTxnId" id="ispTxnIdIsp" type="text" />
          <input name="dataKey" id="dataKeyIsp" type="text" />
          <input name="tmnCode" id="tmnCodeIsp" type="text" />
        </form>

        <!-- Form hidden ƒë·ªÉ POST VNPAY Tr·∫£ g√≥p -->
        <form
          id="payment_form_recurring"
          method="POST"
          action="https://sandbox.vnpayment.vn/isp-svc/recurring-payment/pay"
          style="display: none">
          <input name="ispTxnId" id="ispTxnIdRec" type="text" />
          <input name="dataKey" id="dataKeyRec" type="text" />
          <input name="tmnCode" id="tmnCodeRec" type="text" />
        </form>
        <!-- ================= VNPAY TOKEN FORM ================= -->
        <div id="token-form-section" style="display: none">
          <!-- ‚úÖ Tabs Header -->
          <div class="token-tabs">
            <button class="token-tab active" onclick="showTokenTab('create')">‚ûï T·∫°o Token / Pay & Create</button>
            <button class="token-tab" onclick="showTokenTab('pay')">üí≥ Thanh to√°n b·∫±ng Token ƒë√£ l∆∞u</button>
          </div>

          <!-- ‚úÖ Tab Content: T·∫°o Token -->
          <div id="token-create-tab" class="token-tab-content">
            <h3>T·∫°o Token / Thanh to√°n & T·∫°o Token</h3>
            <form id="tokenForm" onsubmit="submitForm(); return false;">
              <label>Lo·∫°i thao t√°c:</label>
              <select name="vnp_command" id="vnp_command" onchange="onCommandChange()" required>
                <option value="token_create">T·∫°o Token (token_create)</option>
                <option value="pay_and_create">Thanh to√°n & T·∫°o Token (pay_and_create)</option>
              </select>
              <br />

              <label>User ID:</label>
              <input type="text" name="vnp_app_user_id" value="U001" required />
              <br />

              <label>Lo·∫°i th·∫ª:</label>
              <select name="vnp_card_type" required>
                <option value="01">01 - Th·∫ª n·ªôi ƒë·ªãa</option>
                <option value="02">02 - Th·∫ª qu·ªëc t·∫ø</option>
              </select>
              <br />

              <div id="storeTokenGroup" style="display: none">
                <label>L∆∞u Token sau thanh to√°n?</label>
                <select name="vnp_store_token" id="vnp_store_token">
                  <option value="">C√≥ (m·∫∑c ƒë·ªãnh)</option>
                  <option value="1">Kh√¥ng l∆∞u</option>
                </select>
                <br />
              </div>

              <button type="submit">G·ª≠i y√™u c·∫ßu</button>
            </form>
          </div>

          <!-- ‚úÖ Tab Content: Thanh to√°n b·∫±ng Token ƒë√£ l∆∞u -->
          <div id="token-pay-tab" class="token-tab-content" style="display: none">
            <h3>Thanh to√°n b·∫±ng Token ƒë√£ l∆∞u</h3>
            <label>Ch·ªçn Token ƒë√£ l∆∞u:</label>
            <select id="saved-tokens"></select>
            <button onclick="handleTokenPay()">Thanh to√°n b·∫±ng Token</button>
          </div>
        </div>

        <!-- Bank list hi·ªÉn th·ªã sau khi ch·ªçn VNPAY Deeplink -->
        <div id="deeplink-section" style="display: none">
          <h4>Ch·ªçn Ng√¢n h√†ng</h4>
          <div id="bankGrid" class="bank-grid"></div>
          <div id="debugBox"></div>
        </div>
      </div>
    </main>

    <!-- FOOTER -->
    <footer>Copyright ¬© Ph·∫°m VƒÉn T√∫</footer>

    <!-- Scripts -->
    <script src="scripts/config.js"></script>
    <script src="scripts/cart.js"></script>
    <script src="scripts/bankDeeplink.js"></script>
    <script src="scripts/app.js"></script>
    <script src="scripts/payment.js"></script>
    <script src="scripts/token.js"></script>
    <script src="scripts/ibdoanhnghiep.js"></script>
    <script src="scripts/isp.js"></script>
    <script src="scripts/recurring.js"></script>
    <script src="scripts/seapay.js"></script>

    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js").then(() => console.log("Service Worker registered!"));
      }
    </script>

    <script>
      // G·ªçi Apps Script API
      fetch(`${BASE_URL}?action=getPaymentMethods`)
        .then((res) => res.json())
        .then((data) => {
          const enabledMethods = data.enabledMethods;

          // Duy·ªát to√†n b·ªô input radio
          document.querySelectorAll('#payment-section input[type="radio"]').forEach((input) => {
            if (enabledMethods.includes(input.value)) {
              input.parentElement.classList.remove("hidden");
            } else {
              input.parentElement.classList.add("hidden");
            }
          });
        });
    </script>
  </body>
</html>
